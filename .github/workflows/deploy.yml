name: Deploy Netsuite Extractor (Docker)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Debug SSH secrets (optional)
      - name: Ensure SSH secrets exist
        run: |
          echo "SERVER_IP set? -> ${{ secrets.SERVER_IP != '' }}"
          echo "SERVER_USER set? -> ${{ secrets.SERVER_USER != '' }}"
          echo "SERVER_SSH_KEY set? -> ${{ secrets.SERVER_SSH_KEY != '' }}"

      # 2. Deploy via SSH
      - name: Pull code and deploy via Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail
            cd /root/netsuiteapi/NetsuiteDataExtraction
            git config --global --add safe.directory /root/netsuiteapi/NetsuiteDataExtraction
            git reset --hard
            git clean -fd
            git fetch --all
            git checkout main
            git pull origin main

            # Clean up logs and cache before build
            rm -rf logs __pycache__ netsuite_venv

            docker-compose build --no-cache
            docker-compose up -d

            docker ps 
